
{% extends "layout.html" %}

{% block pageTitle %}
  GOV.UK Content Publisher prototype
{% endblock %}

{% block pageScripts %}
<!-- <script src="/public/javascripts/components/button-menu.js"></script>
<script type="text/javascript">
  new GOVUKPublishingFrontend.ButtonMenu({
    container: $('.button-menu-1'),
    mq: '(min-width: 45em)',
    buttonText: 'Actions'
  });
</script> -->
{%- if attachments | length > 1 %}
<script src="https://raw.githack.com/SortableJS/Sortable/master/Sortable.js"></script>
<script type="text/javascript">

  Sortable.prototype.moveItem = function (index, toIndex) {
    var itemEl = this.el.children[index]
        toEl = this.el.children[toIndex]

    this.el.insertBefore(itemEl, toEl && (+toIndex ? toEl.nextElementSibling : toEl))
  }

  var sortableAttachments = Sortable.create(attachmentsList, {
    ghostClass: "app-c-attachment-meta--ghost",
    chosenClass: "app-c-attachment-meta--chosen",
    dragClass: "app-c-attachment-meta--drag"
  })

  attachments = attachmentsList.querySelectorAll('.app-c-attachment-meta')

  attachments.forEach((item, i) => {
    item.querySelector('.js-up').addEventListener("click", function () { sortableAttachments.moveItem(i, i-1) })
    item.querySelector('.js-down').addEventListener("click", function () { sortableAttachments.moveItem(i, i+1) })
  });
</script>
{% endif -%}
{% endblock %}

{% block beforeContent %}
{% include "includes/phase-banner.html" %}
{{ govukBackLink({
  text: "Back",
  href: links.back
}) }}
{% endblock %}

{% block content %}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">

      <div class="govuk-grid-row govuk-!-margin-bottom-8">
        <div class="govuk-grid-column-two-thirds">

          <h1 class="govuk-heading-l">
            Attachments for ‘{{ data.document.title }}’
          </h1>

          <p class="govuk-body">Add an accessible file attachment in an open format or add an external link to a document not published on GOV.UK.</p>

          {{ appButtonMenu({
            classes: 'button-menu-1',
            items: [

              {
                text: 'Add file attachment',
                classes: 'govuk-button',
                href: '/documents/' + data.document.content_id + '/attachments/create?type=file'
              },
              {
                text: 'Add external link',
                classes: 'govuk-button',
                href: '/documents/' + data.document.content_id + '/attachments/create?type=external'
              }
            ]
          }) }}

          <!-- {
            text: 'Add HTML attachment',
            classes: 'govuk-button',
            href: '/documents/' + data.document.content_id + '/attachments/create?type=html'
          }, -->

        </div>
      </div>

      <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
          <h2 class="govuk-heading-m">Attachments</h2>

          {% if attachments | length %}

            <p class="govuk-body govuk-!-margin-bottom-8">All attachments will appear on the document when it’s published.</p>

            {%- if attachments | length > 1 %}<div id="attachmentsList">{% endif -%}

            {%- for attachment in attachments %}

              {%- call appAttachmentActions({
                items: [
                  {
                    text: 'Edit link details' if attachment.type == 'external' else ('Edit file details' if attachment.type == 'file' else 'Edit details'),
                    href: '/documents/' + attachment.document_id + '/attachments/' + attachment.content_id + '/update'
                  },
                  {
                    text: 'Edit publishing details',
                    href: '/documents/' + attachment.document_id + '/attachments/' + attachment.content_id + '/metadata'
                  } if attachment.type != 'external',
                  {
                    text: 'Download',
                    href: '/documents/' + attachment.document_id + '/attachments/' + attachment.content_id + '/download'
                  } if attachment.type == 'file',
                  {
                    text: 'Delete attachment',
                    href: '/documents/' + attachment.document_id + '/attachments/' + attachment.content_id + '/delete',
                    classes: 'app-link--destructive'
                  }
                ] if data.actions != "hide"
              }) %}

                {%- if attachment.type == 'external' %}
                  {%- call appAttachment({
                    heading: {
                      text: attachment.title if attachment.title | length else "Untitled attachment"
                    },
                    href: ('/documents/' + attachment.document_id + '/attachments/' + attachment.content_id) if data.links != "hide"
                  }) %}

                    <p class="govuk-body-s">{{ attachment.url }}</p>

                  {% endcall -%}
                {% endif -%}

                {{ appAttachment({
                  heading: {
                    text: attachment.title if attachment.title | length else "Untitled attachment"
                  },
                  href: ('/documents/' + attachment.document_id + '/attachments/' + attachment.content_id) if data.links != "hide",
                  metadata: {
                    filename: (attachment.title | slugify) + '.pdf',
                    fileSize: 1234560,
                    contentType: 'application/pdf',
                    pageCount: 25,
                    thumbnail: 'document'
                  }
                }) if attachment.type == 'file' }}

                {{ appAttachment({
                  heading: {
                    text: attachment.title if attachment.title | length else "Untitled attachment"
                  },
                  href: ('/documents/' + attachment.document_id + '/attachments/' + attachment.content_id) if data.links != "hide",
                  metadata: {
                    contentType: 'text/html',
                    thumbnail: 'document'
                  }
                }) if attachment.type == 'html' }}

                {%- if attachments | length > 1 %}
                  <div class="app-o-order-controls js-order-controls">
                    {%- if not loop.first %}<button class="govuk-button app-c-button--secondary-quiet js-up">Up</button>{% endif %}
                    {% if not loop.last %}<button class="govuk-button app-c-button--secondary-quiet js-down">Down</button>{% endif -%}
                  </div>
                {% endif -%}

              {% endcall -%}

            {% endfor -%}

            {%- if attachments | length > 1 %}</div>{% endif -%}

          {% else %}

            <p class="govuk-body">No attachments added to this document.</p>

          {% endif -%}

        </div>
      </div>

    </div>
</div>

{% endblock %}
